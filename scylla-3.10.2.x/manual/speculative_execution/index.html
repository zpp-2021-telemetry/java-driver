

<!DOCTYPE html>
<html class="no-js" lang="en">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title> Speculative query execution | Scylla Docs
    </title>
    <meta name="description" content="Scylla is an Apache Cassandra-compatible NoSQL data store that can handle 1 million transactions per second on a single server." />
    <link
      rel="icon"
      href="../../_static/img/favicon.ico"
      type="image/x-icon"
    />
    <link
      rel="icon"
      href="../../_static/img/favicon-32x32.png"
      sizes="32x32"
    />
    <link
      rel="icon"
      href="../../_static/img/favicon-228x228.png"
      sizes="192x192"
    />
    <link
      rel="apple-touch-icon"
      href="../../_static/img/favicon-228x228.png"
    />
    <meta
      name="msapplication-TileImage"
      href="../../_static/img/favicon-228x228.png"
    />
    <link rel="canonical" href="https://docs.scylladb.com/" />
    <link rel="author" href="mailto:info@scylladb.com" />
  <!-- connect to domain of font files -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

  <!-- optionally increase loading priority -->
  <link
    rel="preload"
    as="style"
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap"
  />

  <!-- async CSS -->
  <link
    rel="stylesheet"
    media="print"
    onload="this.onload=null;this.removeAttribute('media');"
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap"
  />

  <!-- no-JS fallback -->
  <noscript>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap"
    />
  </noscript>
  <link
    rel="stylesheet"
    href="../../_static/css/main.css"
    type="text/css"
  />
  <link
    rel="stylesheet"
    href="../../_static/pygments.css"
    type="text/css"
  /> <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />

  <script
    type="text/javascript"
    id="documentation_options"
    data-url_root="../../"
    src="../../_static/documentation_options.js"
  ></script>
  <script
    type="text/javascript"
    src="../../_static/js/runtime.bundle.js"
  ></script>
  <script
    type="text/javascript"
    src="../../_static/js/main.bundle.js"
  ></script> <script src="../../_static/jquery.js"></script> <script src="../../_static/underscore.js"></script> <script src="../../_static/doctools.js"></script> <script src="../../_static/language_data.js"></script> <script src="../../_static/clipboard.min.js"></script> <script src="../../_static/copybutton.js"></script>

    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-T8P2JP");
    </script>
    <!-- End Google Tag Manager -->
    <!-- Marketo -->
    <script type="text/javascript">
      (function () {
        var didInit = false;
        function initMunchkin() {
          if (didInit === false) {
            didInit = true;
            Munchkin.init("791-QBF-350");
          }
        }
        var s = document.createElement("script");
        s.type = "text/javascript";
        s.async = true;
        s.src = "//munchkin.marketo.net/munchkin.js";
        s.onreadystatechange = function () {
          if (this.readyState == "complete" || this.readyState == "loaded") {
            initMunchkin();
          }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName("head")[0].appendChild(s);
      })();
    </script>
    <!-- End Marketo -->
    <!-- Expertrec -->
    <script>
      var id = "e2077224-9ccf-11e9-a0c9-0242ac130002";
      var ci_search = document.createElement("script");
      ci_search.type = "text/javascript";
      ci_search.async = true;
      ci_search.src = "https://cse.expertrec.com/api/js/ci_common.js?id=" + id;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(ci_search, s);
    </script>
    <!-- End Expertrec -->

    <!-- Font Awesome -->
    <script
      src="https://kit.fontawesome.com/b1870adf6a.js"
      crossorigin="anonymous"
    ></script>
    <!-- End Font Awesome -->
  </head>
  
  <body>
     <header class="header">
  <div class="header-logo">
    <a class="header-logo__img" href="https://scylladb.com/">
      <img
        src="../../_static/img/logo-scylla-docs.svg"
        alt="Scylla Documentation Logo"
      />
    </a>
    <span class="header-logo__bar"></span>
    <a class="header-logo__text" href="https://docs.scylladb.com/">
      Documentation
    </a>
  </div>
  <div class="header-navigation">
    <ul
      class="dropdown menu scylla-dropdown scylla-dropdown--header"
      data-dropdown-menu
    >
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Server <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a href="https://docs.scylladb.com/"
              ><i class="scylla-icon scylla-icon--about-us"></i>Scylla Open
              Source</a
            >
          </li>
          <li>
            <a href="https://docs.scylladb.com/"
              ><i class="scylla-icon scylla-icon--enterprise"></i>Scylla
              Enterprise</a
            >
          </li>
          <li>
            <a
              href="https://scylla.docs.scylladb.com/master/alternator/alternator.html"
            >
              <i class="scylla-icon scylla-icon--overview"></i>Scylla
              Alternator</a
            >
          </li>
        </ul>
      </li>
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Cloud <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a href="https://cloud.scylladb.com/">
              <i class="scylla-icon scylla-icon--cloud"></i>Scylla Cloud</a
            >
          </li>
          <li>
            <a href="https://docs.scylladb.com/scylla-cloud/">
              <i class="scylla-icon scylla-icon--cloud-docs"></i>Scylla Cloud
              Docs</a
            >
          </li>
        </ul>
      </li>
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Tools <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a href="https://manager.docs.scylladb.com/">
              <i class="scylla-icon scylla-icon--manager"></i>Scylla Manager</a
            >
          </li>
          <li>
            <a href="https://monitoring.docs.scylladb.com/">
              <i class="scylla-icon scylla-icon--monitoring"></i>Scylla
              Monitoring Stack</a
            >
          </li>
          <li>
            <a href="https://operator.docs.scylladb.com/">
              <i class="scylla-icon scylla-icon--operator"></i>Scylla Operator
            </a>
          </li>
        </ul>
      </li>
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Drivers <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a
              href="https://docs.scylladb.com/using-scylla/drivers/cql-drivers/"
            >
              <i class="scylla-icon scylla-icon--nsql-guides"></i>CQL Drivers
            </a>
          </li>
          <li>
            <a
              href="https://docs.scylladb.com/using-scylla/drivers/dynamo-drivers/"
            >
              <i class="scylla-icon scylla-icon--overview"></i>DynamoDB Drivers
            </a>
          </li>
        </ul>
      </li>
    </ul>
    <div class="header-button">
      <a href="https://www.scylladb.com/download/" class="button">Download</a>
    </div>
  </div>
  <div class="header-search-box">
    <div class="search-box">
      <ci-search></ci-search>
    </div>
  </div>
  <div class="side-nav-toggle" data-toggle="side-nav">
  <div class="side-nav-toggle__button">
    <img src="../../_static/img/menu.svg" alt="Menu" />
  </div>
</div>
</header>
    <section class="layout ">
      <div class="content large-order-2">
         

        <div class="pre-content">
          <div class="pre-content__left"><div class="breadcrumbs">
  <span class="bread__item">
    <a
      href="https://java-driver.docs.scylladb.com"
      class="bread__highlight"
    >
      <i class="fas fa-home"></i> Scylla Java Driver</a
    ></span
  >
  
  <span class="bread__item"
    ><a href="../index.html">Manual</a></span
  >
  
  <span class="bread__item bread__item--last">Speculative query execution</span>
</div></div>
          <div class="pre-content__right"><ul
  class="dropdown menu scylla-dropdown scylla-dropdown--contribute"
  data-dropdown-menu
>
  <li class="scylla-dropdown__item">
    <a class="scylla-dropdown__title" href="#">
      <div class="scylla-dropdown__title--body">
        <i class="icon fa fa-github" aria-hidden="true"></i>
        Contribute
      </div>
      <i class="chevron scylla-icon scylla-icon--chevron-right"></i>
    </a>
    <ul class="menu scylla-dropdown__content">
      <li>
        <a
          href="https://github.com/scylladb/java-driver/issues/new?title=Issue in page Speculative query execution&&body=I%20would%20like%20to%20report%20an%20issue%20in%20page%20https://java-driver.docs.scylladb.com/scylla-3.10.2.x/manual/speculative_execution/index%0A%0A%23%23%23%20Problem%0A%0A%23%23%23%20%20Suggest%20a%20fix"
          target="_blank"
          >Report a doc issue
          <i class="icon fa fa-external-link" aria-hidden="true"></i
        ></a>
      </li>
      
      <li>
             
        <a
          href="https://github.com/scylladb/java-driver/edit/scylla-3.10.2.x/docs/source/manual/speculative_execution/index.md"
          target="_blank"
          >Edit this page
          <i class="icon fa fa-external-link" aria-hidden="true"></i
        ></a>
      </li>
      
      <li>
        <a href="https://docs.scylladb.com/contribute/" target="_blank"
          >Learn how to contribute
          <i class="icon fa fa-external-link" aria-hidden="true"></i
        ></a>
      </li>
    </ul>
  </li>
</ul></div>
        </div>
         <div class="section" id="speculative-query-execution">
<h1>Speculative query execution<a class="headerlink" href="#speculative-query-execution" title="Permalink to this headline">¶</a></h1>
<p>Sometimes a Cassandra node might be experiencing difficulties (ex: long
GC pause) and take longer than usual to reply. Queries sent to that node
will experience bad latency.</p>
<p>One thing we can do to improve that is pre-emptively start a second
execution of the query against another node, before the first node has
replied or errored out. If that second node replies faster, we can send
the response back to the client (we also cancel the first execution –
note that “cancelling” in this context simply means discarding the response
when it arrives later, Cassandra does not support cancellation of in flight
requests at this stage):</p>
<div class="highlight-ditaa notranslate"><div class="highlight"><pre><span></span>client           driver          exec1  exec2
--+----------------+--------------+------+---
  <span class="p">|</span> execute<span class="o">(</span>query<span class="o">)</span> <span class="p">|</span>
  <span class="p">|</span>---------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> query host1
  <span class="p">|</span>                <span class="p">|</span>-------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>     query host2
  <span class="p">|</span>                <span class="p">|</span>--------------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>     host2 replies   <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>&lt;--------------------<span class="p">|</span>
  <span class="p">|</span>   <span class="nb">complete</span>     <span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>&lt;---------------<span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> cancel       <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>-------------&gt;<span class="p">|</span>
</pre></div>
</div>
<p>Or the first node could reply just after the second execution was
started. In this case, we cancel the second execution. In other words,
whichever node replies faster “wins” and completes the client query:</p>
<div class="highlight-ditaa notranslate"><div class="highlight"><pre><span></span>client           driver          exec1  exec2
--+----------------+--------------+------+---
  <span class="p">|</span> execute<span class="o">(</span>query<span class="o">)</span> <span class="p">|</span>
  <span class="p">|</span>---------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> query host1
  <span class="p">|</span>                <span class="p">|</span>-------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>     query host2
  <span class="p">|</span>                <span class="p">|</span>--------------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> host1 replies<span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>&lt;-------------<span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>   <span class="nb">complete</span>     <span class="p">|</span>                     <span class="p">|</span>
  <span class="p">|</span>&lt;---------------<span class="p">|</span>                     <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> cancel              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>--------------------&gt;<span class="p">|</span>
</pre></div>
</div>
<p>Speculative executions are <strong>disabled</strong> by default. The following
sections cover the practical details and how to enable them.</p>
<div class="section" id="query-idempotence">
<h2>Query idempotence<a class="headerlink" href="#query-idempotence" title="Permalink to this headline">¶</a></h2>
<p>If a query is <a class="reference external" href="../idempotence/">not idempotent</a>, the driver will never schedule speculative executions for it, because
there is no way to guarantee that only one node will apply the mutation.</p>
</div>
<div class="section" id="enabling-speculative-executions">
<h2>Enabling speculative executions<a class="headerlink" href="#enabling-speculative-executions" title="Permalink to this headline">¶</a></h2>
<p>Speculative executions are controlled by an instance of
<a class="reference external" href="https://java-driver.docs.scylladb.com/stable/api/com/datastax/driver/core/policies/SpeculativeExecutionPolicy.html">SpeculativeExecutionPolicy</a> provided when initializing the
<code class="docutils literal notranslate"><span class="pre">Cluster</span></code>.  This policy defines the threshold after which a new
speculative execution will be triggered.</p>
<p>Two implementations are provided with the driver:</p>
<div class="section" id="constantspeculativeexecutionpolicy">
<h3><a class="reference external" href="https://java-driver.docs.scylladb.com/stable/api/com/datastax/driver/core/policies/ConstantSpeculativeExecutionPolicy.html">ConstantSpeculativeExecutionPolicy</a><a class="headerlink" href="#constantspeculativeexecutionpolicy" title="Permalink to this headline">¶</a></h3>
<p>This simple policy uses a constant threshold:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Cluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">addContactPoint</span><span class="o">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">withSpeculativeExecutionPolicy</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">ConstantSpeculativeExecutionPolicy</span><span class="o">(</span>
            <span class="mi">500</span><span class="o">,</span> <span class="c1">// delay before a new execution is launched</span>
            <span class="mi">2</span>    <span class="c1">// maximum number of executions</span>
        <span class="o">))</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
<p>Given the above configuration, an idempotent query would be handled this
way:</p>
<ul class="simple">
<li><p>start the initial execution at t0;</p></li>
<li><p>if no response has been received at t0 + 500 milliseconds, start a
speculative execution on another node;</p></li>
<li><p>if no response has been received at t0 + 1000 milliseconds, start
another speculative execution on a third node.</p></li>
</ul>
</div>
<div class="section" id="percentilespeculativeexecutionpolicy">
<h3><a class="reference external" href="https://java-driver.docs.scylladb.com/stable/api/com/datastax/driver/core/policies/PercentileSpeculativeExecutionPolicy.html">PercentileSpeculativeExecutionPolicy</a><a class="headerlink" href="#percentilespeculativeexecutionpolicy" title="Permalink to this headline">¶</a></h3>
<p>This policy sets the threshold at a given latency percentile for the
current host, based on recent statistics.</p>
<p>First and foremost, make sure that the <a class="reference external" href="http://hdrhistogram.github.io/HdrHistogram/">HdrHistogram</a> library (used
under the hood to collect latencies) is in your classpath. It’s defined
as an optional dependency in the driver’s POM, so you’ll need to
explicitly depend on it:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.hdrhistogram<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>HdrHistogram<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.1.10<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<p>Then create a <a class="reference external" href="https://java-driver.docs.scylladb.com/stable/api/com/datastax/driver/core/PercentileTracker.html">PercentileTracker</a> that will collect latency histograms for your <code class="docutils literal notranslate"><span class="pre">Cluster</span></code>. Two
implementations are provided out of the box:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://java-driver.docs.scylladb.com/stable/api/com/datastax/driver/core/ClusterWidePercentileTracker.html">ClusterWidePercentileTracker</a>: maintains a single histogram for the whole cluster. This means
queries will be compared against the global performance of all the hosts in the cluster.</p></li>
<li><p><a class="reference external" href="https://java-driver.docs.scylladb.com/stable/api/com/datastax/driver/core/PerHostPercentileTracker.html">PerHostPercentileTracker</a>: maintains a histogram per host. This means queries to a host will
only be compared against previous queries to the same host.</p></li>
</ul>
<p>We recommend the cluster-wide strategy: in practice, we’ve found that it produces better results,
because it does a better job at penalizing hosts that are consistently slower.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// There are more options than shown here, please refer to the API docs</span>
<span class="c1">// for more information</span>
<span class="n">PercentileTracker</span> <span class="n">tracker</span> <span class="o">=</span> <span class="n">ClusterWidePercentileTracker</span>
    <span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="mi">15000</span><span class="o">)</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
<p>Create an instance of the policy with the tracker, and pass it to your
cluster:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">PercentileSpeculativeExecutionPolicy</span> <span class="n">policy</span> <span class="o">=</span>
    <span class="k">new</span> <span class="n">PercentileSpeculativeExecutionPolicy</span><span class="o">(</span>
        <span class="n">tracker</span><span class="o">,</span>
        <span class="mf">99.0</span><span class="o">,</span>     <span class="c1">// percentile</span>
        <span class="mi">2</span><span class="o">);</span>       <span class="c1">// maximum number of executions</span>

<span class="n">Cluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">addContactPoint</span><span class="o">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">withSpeculativeExecutionPolicy</span><span class="o">(</span><span class="n">policy</span><span class="o">)</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">PercentileTracker</span></code> may also be used with a slow query
logger (see the <a class="reference external" href="../logging/">Logging</a> section). In that case, you would
create a single tracker object and share it with both components.</p>
</div>
<div class="section" id="using-your-own">
<h3>Using your own<a class="headerlink" href="#using-your-own" title="Permalink to this headline">¶</a></h3>
<p>As with all policies, you are free to provide your own by implementing
<code class="docutils literal notranslate"><span class="pre">SpeculativeExecutionPolicy</span></code>.</p>
</div>
</div>
<div class="section" id="how-speculative-executions-affect-retries">
<h2>How speculative executions affect retries<a class="headerlink" href="#how-speculative-executions-affect-retries" title="Permalink to this headline">¶</a></h2>
<p>Turning speculative executions on doesn’t change the driver’s <a class="reference external" href="../retries/">retry</a> behavior. Each
parallel execution will trigger retries independently:</p>
<div class="highlight-ditaa notranslate"><div class="highlight"><pre><span></span>client           driver          exec1  exec2
--+----------------+--------------+------+---
  <span class="p">|</span> execute<span class="o">(</span>query<span class="o">)</span> <span class="p">|</span>
  <span class="p">|</span>---------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> query host1
  <span class="p">|</span>                <span class="p">|</span>-------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> unavailable  <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>&lt;-------------<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>retry at lower CL
  <span class="p">|</span>                <span class="p">|</span>-------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>     query host2
  <span class="p">|</span>                <span class="p">|</span>--------------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>     server error    <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>&lt;--------------------<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>   retry on host3
  <span class="p">|</span>                <span class="p">|</span>--------------------&gt;<span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>              <span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> host1 replies<span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>&lt;-------------<span class="p">|</span>      <span class="p">|</span>
  <span class="p">|</span>   <span class="nb">complete</span>     <span class="p">|</span>                     <span class="p">|</span>
  <span class="p">|</span>&lt;---------------<span class="p">|</span>                     <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span> cancel              <span class="p">|</span>
  <span class="p">|</span>                <span class="p">|</span>--------------------&gt;<span class="p">|</span>
</pre></div>
</div>
<p>The only impact is that all executions of the same query always share
the same query plan, so each host will be used by at most one execution.</p>
</div>
<div class="section" id="tuning-and-practical-details">
<h2>Tuning and practical details<a class="headerlink" href="#tuning-and-practical-details" title="Permalink to this headline">¶</a></h2>
<p>The goal of speculative executions is to improve overall latency (the
time between <code class="docutils literal notranslate"><span class="pre">execute(query)</span></code> and <code class="docutils literal notranslate"><span class="pre">complete</span></code> in the diagrams above) at
high percentiles. On the flipside, they cause the driver to send more
individual requests, so throughput will not necessarily improve.</p>
<p>You can monitor how many speculative executions were triggered with the
<code class="docutils literal notranslate"><span class="pre">speculative-executions</span></code> metric (exposed in the Java API as
<a class="reference external" href="https://java-driver.docs.scylladb.com/stable/api/com/datastax/driver/core/Metrics.Errors.html#getSpeculativeExecutions--">cluster.getMetrics().getErrors().getSpeculativeExecutions()</a>).
It should only be a few percents of the total number of requests
(<a class="reference external" href="https://java-driver.docs.scylladb.com/stable/api/com/datastax/driver/core/Metrics.html#getRequestsTimer--">cluster.getMetrics().getRequestsTimer().getCount()</a>).</p>
<div class="section" id="stream-id-exhaustion">
<h3>Stream id exhaustion<a class="headerlink" href="#stream-id-exhaustion" title="Permalink to this headline">¶</a></h3>
<p>One side-effect of speculative executions is that many requests are
cancelled, which can lead to a phenomenon called <em>stream id exhaustion</em>:
each TCP connection can handle multiple simultaneous requests,
identified by a unique number called <em>stream id</em>. When a request gets
cancelled, we can’t reuse its stream id immediately because we might
still receive a response from the server later. If this happens often,
the number of available stream ids diminishes over time, and when it
goes below a given threshold we close the connection and create a new
one. If requests are often cancelled, so will see connections being
recycled at a high rate.</p>
<p>One way to detect this is to monitor open connections per host
(<a class="reference external" href="https://java-driver.docs.scylladb.com/stable/api/com/datastax/driver/core/Session.State.html">Session.getState().getOpenConnections(host)</a>) against
TCP connections at the OS level. If open connections stay constant but
you see many TCP connections in closing states, you might be running
into this issue. Try raising the speculative execution threshold.</p>
<p>This problem is more likely to happen with version 2 of the native
protocol, because each TCP connection only has 128 stream ids. With
version 3 (driver 2.1.2 or above with Cassandra 2.1 or above), there are
32K stream ids per connection, so higher cancellation rates can be
sustained. If you’re unsure of which native protocol version you’re
using, you can check with
<a class="reference external" href="https://java-driver.docs.scylladb.com/stable/api/com/datastax/driver/core/ProtocolOptions.html#getProtocolVersion--">cluster.getConfiguration().getProtocolOptions().getProtocolVersion()</a>.</p>
</div>
<div class="section" id="request-ordering-and-client-timestamps">
<h3>Request ordering and client timestamps<a class="headerlink" href="#request-ordering-and-client-timestamps" title="Permalink to this headline">¶</a></h3>
<p>Another issue that might arise is that you get unintuitive results
because of request ordering. Suppose you run the following query with
speculative executions enabled:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insert</span> <span class="n">into</span> <span class="n">my_table</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="n">values</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>The first execution is a bit too slow, so a second execution gets
triggered. Finally, the first execution completes, so the client code
gets back an acknowledgement, and the second execution is cancelled.
However, cancelling only means that the driver stops waiting for the
server’s response, the request could still be “on the wire”; let’s
assume that this is the case.</p>
<p>Now you run the following query, which completes successfully:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">delete</span> <span class="kn">from</span> <span class="nn">my_table</span> <span class="n">where</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<p>But now the second execution of the first query finally reaches its
target node, which applies the mutation. The row that you’ve just
deleted is back!</p>
<p>The workaround is to use a timestamp with your queries:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insert</span> <span class="n">into</span> <span class="n">my_table</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="n">values</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="n">USING</span> <span class="n">TIMESTAMP</span> <span class="mi">1432764000</span><span class="p">;</span>
</pre></div>
</div>
<p>If you’re using native protocol v3, you can also enable <a class="reference external" href="../query_timestamps/#client-side-generation">client-side
timestamps</a> to have this done
automatically.</p>
</div>
</div>
</div>
  <div class="content-navigation">
  <div class="navigation navigation--prev">
    <a class="navigation__link" href="../socket_options/index.html">
      <button class="navigation__button">
        <i class="scylla-icon scylla-icon--chevron-left"></i>
      </button>
      <div class="navigation__title">
        <span class="colored">PREVIOUS</span> <br />Socket options
      </div>
    </a>
  </div>
  <div class="navigation navigation--next">
    <a class="navigation__link" href="../ssl/index.html">
      <div class="navigation__title">
        <span class="colored">NEXT</span> <br />SSL
      </div>
      <button class="navigation__button">
        <i class="scylla-icon scylla-icon--chevron-right"></i>
      </button>
    </a>
  </div>
</div> 
      </div>
      <div
        class="sidebar-left  large-order-1"
      > <div id="side-nav" class="side-nav" data-closable data-toggler=".show">
  <div class="side-nav__search">
    <div class="search-box">
      <ci-search></ci-search>
    </div>
  </div>
  <div class="side-nav__versions">
     <ul
  class="dropdown menu scylla-dropdown scylla-dropdown--versions "
  data-dropdown-menu
>
  <li class="scylla-dropdown__item">
    <a class="scylla-dropdown__title" href="#">
       3.10.2.x 
      <i class="chevron scylla-icon scylla-icon--chevron-right"></i>
    </a>
    <ul class="menu scylla-dropdown__content"> 
      <li>
        <a href="../../../scylla-3.7.2.x/index.html"
          >3.7.2.x</a
        >
      </li>
       
      <li>
        <a href="index.html"
          >3.10.2.x</a
        >
      </li>
       
    </ul>
  </li>
</ul> 
  </div>
  <div class="side-nav__content">
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Scylla Java Driver for Scylla and Apache Cassandra®</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../index.html">Manual</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label for="toctree-checkbox-1"><i class="scylla-icon scylla-icon--expand"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../address_resolution/index.html">Address resolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../async/index.html">Asynchronous programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auth/index.html">Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../compression/index.html">Compression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../control_connection/index.html">Control connection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../custom_codecs/index.html">Custom Codecs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../custom_payloads/index.html">Custom Payloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../idempotence/index.html">Query idempotence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../load_balancing/index.html">Load balancing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/index.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata/index.html">Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics/index.html">Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../native_protocol/index.html">Native protocol</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../object_mapper/index.html">Object Mapper</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label for="toctree-checkbox-2"><i class="scylla-icon scylla-icon--expand"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../object_mapper/creating/index.html">Definition of mapped classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../object_mapper/custom_codecs/index.html">Using custom codecs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../object_mapper/using/index.html">Using the mapper</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../osgi/index.html">OSGi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../paging/index.html">Paging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pooling/index.html">Connection pooling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../query_timestamps/index.html">Query timestamps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reconnection/index.html">Reconnection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../retries/index.html">Retries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shaded_jar/index.html">Using the shaded JAR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../socket_options/index.html">Socket options</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Speculative query execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ssl/index.html">SSL</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../statements/index.html">Statements</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label for="toctree-checkbox-3"><i class="scylla-icon scylla-icon--expand"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../statements/simple/index.html">Simple statements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../statements/prepared/index.html">Prepared statements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../statements/built/index.html">Built statements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../statements/batch/index.html">Batch statements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tuples/index.html">Using Tuples with the Java driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../udts/index.html">User-defined types</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../upgrade_guide/index.html">Upgrade guide</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label for="toctree-checkbox-4"><i class="scylla-icon scylla-icon--expand"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../upgrade_guide/migrating_from_astyanax/index.html">Migrating from Astyanax</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label for="toctree-checkbox-5"><i class="scylla-icon scylla-icon--expand"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../upgrade_guide/migrating_from_astyanax/configuration/index.html">Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../upgrade_guide/migrating_from_astyanax/language_level_changes/index.html">Language change : from Thrift to CQL</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../upgrade_guide/migrating_from_astyanax/queries_and_results/index.html">Queries and Results</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/index.html">Changelog</a></li>
</ul>

  </div>
</div>
      </div>
      
      <div class="sidebar-right large-order-3">
         <div class="secondary-side-nav">
  <div class="secondary-side-nav__content">
    <p class="topic-title">On this page</p>
    <ul>
<li><a class="reference internal" href="#">Speculative query execution</a><ul>
<li><a class="reference internal" href="#query-idempotence">Query idempotence</a></li>
<li><a class="reference internal" href="#enabling-speculative-executions">Enabling speculative executions</a><ul>
<li><a class="reference internal" href="#constantspeculativeexecutionpolicy">ConstantSpeculativeExecutionPolicy</a></li>
<li><a class="reference internal" href="#percentilespeculativeexecutionpolicy">PercentileSpeculativeExecutionPolicy</a></li>
<li><a class="reference internal" href="#using-your-own">Using your own</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-speculative-executions-affect-retries">How speculative executions affect retries</a></li>
<li><a class="reference internal" href="#tuning-and-practical-details">Tuning and practical details</a><ul>
<li><a class="reference internal" href="#stream-id-exhaustion">Stream id exhaustion</a></li>
<li><a class="reference internal" href="#request-ordering-and-client-timestamps">Request ordering and client timestamps</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
</div> 
      </div>
    </section>

    <footer class="footer">
  <div class="footer-group">
    <div class="footer-top">
      <a class="footer-logo" href="https://www.scylladb.com"
        ><img
          src="../../_static/img/logo-scylla-horizontal-RGB.svg"
          alt="Logo"
      /></a>
      <div class="footer-links">
        <a class="footer-links__link" href="https://docs.scylladb.com/">Docs</a>
        <a
          class="footer-links__link"
          href="https://www.scylladb.com/company/contact-us/"
          >Contact Us</a
        >
        <a class="footer-links__link" href="https://www.scylladb.com/company/"
          >About Us</a
        >
      </div>
      <div class="footer-actions">
        <a
          class="footer-actions__link"
          href="https://groups.google.com/g/scylladb-users"
          target="_blank"
          ><span
            data-tooltip
            tabindex="1"
            title="User mailing list"
            data-position="bottom"
          >
            <img
              src="../../_static/img/icons/icon-mail-list.svg"
              alt="Mail List Icon"
            />
          </span>
        </a>
        <a
          class="footer-actions__link"
          href="http://slack.scylladb.com/"
          target="_blank"
          ><span
            data-tooltip
            tabindex="1"
            title="User Slack channel"
            data-position="bottom"
          >
            <img
              src="../../_static/img/icons/icon-slack.svg"
              alt="Slack Icon"
          /></span>
        </a>
      </div>
    </div>

    <div class="footer-bottom">
      <div class="footer-bottom__copyright"> &#169; 2021, ScyllaDB. All rights reserved.
      </div>
      <div class="footer-bottom__last-updated">
        Last updated on 02 November 2021.
      </div>
      <div class="footer-bottom__version">
        Powered by
        <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a> &amp;
        <a href="https://sphinx-theme.scylladb.com/"
          >ScyllaDB Theme 1.0.5</a
        >
      </div>
    </div>
  </div>
</footer>

    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-T8P2JP"
        height="0"
        width="0"
        style="display: none; visibility: hidden"
      ></iframe>
    </noscript>
  </body>
</html>